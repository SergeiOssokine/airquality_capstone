
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../..">
      
      
        <link rel="next" href="../location_data_deployment/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.11">
    
    
      
        <title>User Guide - Airquality Capstone Project</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4af4bdda.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#air-quality-capstone-project" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Airquality Capstone Project" class="md-header__button md-logo" aria-label="Airquality Capstone Project" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Airquality Capstone Project
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              User Guide
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/SergeiOssokine/airquality_capstone" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Airquality Capstone Project" class="md-nav__button md-logo" aria-label="Airquality Capstone Project" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Airquality Capstone Project
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/SergeiOssokine/airquality_capstone" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    User Guide
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            User Guide
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    User Guide
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    User Guide
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction-and-problem-statement" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction and Problem Statement
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setting up">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#google-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Google Cloud
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Prefect Cloud
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openaq" class="md-nav__link">
    <span class="md-ellipsis">
      OpenAQ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preset" class="md-nav__link">
    <span class="md-ellipsis">
      Preset
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-by-step-instructions" class="md-nav__link">
    <span class="md-ellipsis">
      Step-by-step instructions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step-by-step instructions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-up-python" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up python
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-the-project" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring the project
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparing-gcp-infrastructure" class="md-nav__link">
    <span class="md-ellipsis">
      Preparing GCP infrastructure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparing-prefect-deployments" class="md-nav__link">
    <span class="md-ellipsis">
      Preparing Prefect deployments
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build-and-push-the-job-docker-image" class="md-nav__link">
    <span class="md-ellipsis">
      Build and push the job docker image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparing-the-location-data" class="md-nav__link">
    <span class="md-ellipsis">
      Preparing the location data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performing-the-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Performing the analysis
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-sources" class="md-nav__link">
    <span class="md-ellipsis">
      Data sources
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../location_data_deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Preparing location data in detail
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../analysis_deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Performing analysis in detail
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Python API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Python API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../python_docs/modules_api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Module documentation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction-and-problem-statement" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction and Problem Statement
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setting up">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#google-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Google Cloud
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#prefect-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Prefect Cloud
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openaq" class="md-nav__link">
    <span class="md-ellipsis">
      OpenAQ
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preset" class="md-nav__link">
    <span class="md-ellipsis">
      Preset
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-by-step-instructions" class="md-nav__link">
    <span class="md-ellipsis">
      Step-by-step instructions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Step-by-step instructions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-up-python" class="md-nav__link">
    <span class="md-ellipsis">
      Setting up python
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-the-project" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring the project
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparing-gcp-infrastructure" class="md-nav__link">
    <span class="md-ellipsis">
      Preparing GCP infrastructure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparing-prefect-deployments" class="md-nav__link">
    <span class="md-ellipsis">
      Preparing Prefect deployments
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#build-and-push-the-job-docker-image" class="md-nav__link">
    <span class="md-ellipsis">
      Build and push the job docker image
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparing-the-location-data" class="md-nav__link">
    <span class="md-ellipsis">
      Preparing the location data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#performing-the-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      Performing the analysis
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#data-sources" class="md-nav__link">
    <span class="md-ellipsis">
      Data sources
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="air-quality-capstone-project">Air quality capstone project</h1>
<h2 id="introduction-and-problem-statement">Introduction and Problem Statement</h2>
<p>Cities face a lot of problems with poor air quality due to a number of polluting factors, such as high levels of industrialisation, more cars, and factories. Extensive studies have shown that poor air quality is connected to a vast range of long-term health ailments.</p>
<p>Recently, more and more detailed data has become available online through the coordination of universities, government agencies, companies, and citizen scientists, giving us a wealth of information about the extent of the problem and the impact that various approaches to tackling air pollutions might have.</p>
<p><strong>In this project we analyze 2024 air quality data for Berlin. In particular, we compute the daily averages for different pollutants and compare them to the recommendations by World Health Organization (WHO).</strong></p>
<p>We use the following tech stack:</p>
<ul>
<li><a href="https://www.docker.com/">Docker</a> for containerisation</li>
<li><a href="https://www.prefect.io/">Prefect Cloud</a> for orchestration</li>
<li><a href="https://cloud.google.com/">Google Cloud Platform</a> for cloud services, in particular Cloud Storage as a data lake, BigQuery as a data warehouse, and CloudRun for containerized executions of <code>Prefect</code> jobs.</li>
<li><a href="https://www.getdbt.com/">dbt</a> to orchestrate and perform SQL transformations</li>
<li><a href="https://preset.io/">Preset</a>, a managed solution for <a href="https://superset.apache.org/">Apache Superset</a> for dashboarding</li>
<li><a href="https://www.terraform.io/">Terraform</a> for provisioning resources on GCP and Prefect Cloud</li>
<li><a href="https://www.mkdocs.org/">mkdocs</a> for documentation</li>
</ul>
<p>The overall architecture of the project is shown below:</p>
<p><img alt="" src="../images/architecture.svg" /></p>
<p>You can find detailed documentation <a href="https://sergeiossokine.github.io/airquality_capstone/">here</a>.</p>
<h2 id="setting-up">Setting up</h2>
<p>You will need the following running on your machine:</p>
<ul>
<li>Docker (v27.0 or later) with docker compose</li>
<li>Terraform (v1.11.3 or later)</li>
<li>jq-1.6</li>
<li>GNU make (4.3 or later)</li>
<li>Google Cloud CLI (<code>gcloud</code>).</li>
</ul>
<p>Make sure all of these are in your <code>PATH</code>.</p>
<p><strong>Note that this project will work on Linux-like operating systems. If you are on Windows, you will need to use <a href="https://learn.microsoft.com/en-us/windows/wsl/install">WSL2</a>.</strong></p>
<h3 id="google-cloud">Google Cloud</h3>
<p>You will need to set up a GCP account and create a project. Create a free account and project and then create a <code>terraform</code> service user as described in Week 1 of the <a href="https://github.com/DataTalksClub/data-engineering-zoomcamp/tree/main/01-docker-terraform#movie_camera-introduction-terraform-concepts-and-overview-a-primer">DEZoomcamp</a>. Save the <code>json</code> service credentials in a safe place. Then grant this service account the following roles:</p>
<ul>
<li>Artifact Registry Administrator</li>
<li>BigQuery Admin</li>
<li>Cloud Run Developer</li>
<li>Logs Writer</li>
<li>Service Account User</li>
<li>Storage Admin</li>
</ul>
<h3 id="prefect-cloud">Prefect Cloud</h3>
<p>For orchestration we will use Prefect Cloud, which has a generous free tier. To get started, create a free account and then create an API key and save it as recommended via the <code>prefect cloud login -k &lt;your-api-key&gt;</code>. Also run</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">PREFECT_API_KEY</span><span class="o">=</span><span class="s2">&quot;&lt;your-api-key&gt;&quot;</span>
</code></pre></div>
<h3 id="openaq">OpenAQ</h3>
<p>In order to be able to download the air quality data you will need an OpenAQ API key. Create a free account and get the API key as described <a href="https://docs.openaq.org/using-the-api/api-key">here</a> and store it in a safe place, in a <code>json</code> file that looks like</p>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;value&quot;</span><span class="p">:</span><span class="s2">&quot;YOURAPIKEYHERE&quot;</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="preset">Preset</h3>
<p>The dashboards are hosted on <a href="https://preset.io/">Preset Cloud</a>, which is a managed solution for creating dashboards with <a href="https://superset.apache.org/">Apache Superset</a>, an open-source alternative to Tableau, etc. You will need to create a free account. You will also need to create a connection to the analysis data that will be stored in BigQuery. For detailed instructions, see <a href="https://docs.preset.io/docs/big-query-database">here</a></p>
<h2 id="step-by-step-instructions">Step-by-step instructions</h2>
<p>Throughout the project,  we use <code>make</code> to perform various actions. Note that whenever a make command is mentioned, it should be invoked at the top-level of the repo. To see the full list of possible commands, simply run</p>
<div class="highlight"><pre><span></span><code>make help
</code></pre></div>
<p>Log in to cloud services (use browser-based authentication)</p>
<div class="highlight"><pre><span></span><code>gcloud auth login
</code></pre></div>
<p>and</p>
<div class="highlight"><pre><span></span><code>prefect cloud login
</code></pre></div>
<h3 id="setting-up-python">Setting up python</h3>
<p>You will need many python libraries to run this project. To quickly get there, simply run</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>setup_env
</code></pre></div>
<p>which will:</p>
<ul>
<li>install <a href="https://github.com/astral-sh/uv">uv</a></li>
<li>create a virtual environment for the project under <code>.capstone</code></li>
<li>install all the necessary libararies (see <code>setup/python_env/requirements.txt</code>)</li>
</ul>
<h3 id="configuring-the-project">Configuring the project</h3>
<p>You will need to configure the project by editing the file <code>setup/conf/config.yaml</code>. At a minimum, you must provide the following:</p>
<ul>
<li><code>gcp_project_name</code> - the name of the GCP project you have created</li>
<li><code>gcp_credentials</code> - the absolute path to the JSON file with GCP credentials for the service account</li>
<li><code>openaq_credentials</code> - the absolute path to the file that contains your OpenAQ API key</li>
</ul>
<p>Once you have done this, run</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>create_config
</code></pre></div>
<p>This will do the following:</p>
<ul>
<li>create <code>tfvars</code> files in <code>infra/tf/*</code> to configure the terraform infrastructure</li>
<li>create a <code>setup/conf/.project_config.yaml</code> which will be used by other scripts</li>
</ul>
<h3 id="preparing-gcp-infrastructure">Preparing GCP infrastructure</h3>
<p>The project uses GCS as a data lake and BigQuery as a data warehouse. This infrastructure is managed via Terraform. To deploy it,
run</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>deploy_infra
</code></pre></div>
<p>Terraform will show what infrastructure will be created. Type in "yes" when asked and hit enter.
Aside from a GCS bucket and a BigQuery dataset, we also create a Artifact Registry repository to hold the docker image that is used for analysis.</p>
<h3 id="preparing-prefect-deployments">Preparing Prefect deployments</h3>
<p>We use Prefect as the orchestrator, similar to Kestra used in the course. For a quick summary of relevant concepts, see <a href="../prefect/">here</a>.
To make the deployments run</p>
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>deploy_prefect_flows
</code></pre></div>
<p>This will create all the necessary resources on Prefect cloud to be ready to run analysis jobs.</p>
<h3 id="build-and-push-the-job-docker-image">Build and push the job docker image</h3>
<p>To be able to push the docker image to the Artifact Registry on GCP that we created you need to authorize this. Do so by running:</p>
<div class="highlight"><pre><span></span><code>gcloud<span class="w"> </span>auth<span class="w"> </span>configure-docker<span class="w"> </span>europe-west1-docker.pkg.dev
</code></pre></div>
<p>If you changed the <code>gcp_region</code> variable in <code>config.yaml</code> you will need to adjust the command accordingly.</p>
<p>You can now run the following to build and push the image:
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>create_work_image
</code></pre></div></p>
<h3 id="preparing-the-location-data">Preparing the location data</h3>
<p>OpenAQ provides data from thousands of different sensors around the globe. Each sensor has a unique ID (sensor_id) and location (encoded as longitude, latitude) as well as location ID. To analyze a particular geographical location by name (e.g. a city like Toronto or New Dehli) we need to associate the <code>location_id</code> with the geographical location. For a much more detailed breakdown, see <a href="../location_data_deployment/">here</a>.</p>
<p>To start the flow run
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>trigger_setup_flow
</code></pre></div></p>
<p>Follow the link to see the progress of this job. It should take around 10 minutes to run.</p>
<h3 id="performing-the-analysis">Performing the analysis</h3>
<p>Next we perform the actual analysis and obtain the dataset that computes that shows the hourly measurements of different pollutants at all the different stations in Berlin, as well as their spatial average. For more details, see <a href="">here</a>.</p>
<p>To execute the analysis run
<div class="highlight"><pre><span></span><code>make<span class="w"> </span>trigger_analysis_flow
</code></pre></div></p>
<p>This job will take about 3 minutes to run and will create the final dataset needed for creating the dashboard.</p>
<h2 id="data-sources">Data sources</h2>
<p>The measurement data comes from <a href="https://openaq.org/">OpenAQ</a>, which provides data via API as well as bulk download. We also make use of geographical location data from <a href="https://www.geoapify.com/">GeoApify</a>, see in particular <a href="https://www.geoapify.com/download-all-the-cities-towns-villages/">here</a>. The daily limits for exposure to different pollutants were taken from the <a href="https://www.who.int/news-room/feature-stories/detail/what-are-the-who-air-quality-guidelines">2021 WHO guidelines</a>.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
    
  </body>
</html>